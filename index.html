<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hong Kong Weather Data Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #2d3436;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #636e72;
            margin: 50px 0;
        }
        
        .error {
            background: #ff7675;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .weather-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #0984e3;
        }
        
        .weather-card h3 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .current-weather {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .weather-icon {
            font-size: 4em;
            margin-right: 20px;
        }
        
        .weather-details {
            flex: 1;
        }
        
        .temperature {
            font-size: 3em;
            font-weight: bold;
            color: #e17055;
        }
        
        .humidity {
            font-size: 1.2em;
            color: #74b9ff;
            margin-top: 5px;
        }
        
        .warning {
            background: #fdcb6e;
            border: 1px solid #e17055;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .warning.alert {
            background: #ff7675;
            color: white;
        }
        
        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .location-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .location-name {
            font-size: 0.9em;
            color: #636e72;
            margin-bottom: 5px;
        }
        
        .location-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3436;
        }
        
        .rainfall-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .rainfall-item:last-child {
            border-bottom: none;
        }
        
        .rainfall-value {
            font-weight: bold;
            color: #74b9ff;
        }
        
        .last-updated {
            text-align: center;
            color: #636e72;
            font-size: 0.9em;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .refresh-btn {
            background: #0984e3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #74b9ff;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .chart-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .chart-controls select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .chart-controls button {
            padding: 5px 15px;
            background: #74b9ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .chart-controls button:hover {
            background: #0984e3;
        }
        
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .forecast-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .forecast-date {
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 5px;
        }
        
        .forecast-week {
            font-size: 0.9em;
            color: #636e72;
            margin-bottom: 10px;
        }
        
        .forecast-icon {
            font-size: 2em;
            margin: 10px 0;
        }
        
        .forecast-temp {
            font-size: 1.1em;
            font-weight: bold;
            color: #e17055;
            margin: 5px 0;
        }
        
        .forecast-weather {
            font-size: 0.9em;
            color: #2d3436;
            margin: 5px 0;
        }
        
        .forecast-details {
            font-size: 0.8em;
            color: #636e72;
            margin-top: 10px;
        }
        
        .general-situation {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .weather-grid {
                grid-template-columns: 1fr;
            }
            
            .locations-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .forecast-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå¶Ô∏è Hong Kong Weather Dashboard</h1>
        
        <div id="loading" class="loading">
            Loading weather data...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="weather-content" style="display: none;">
            <div class="weather-grid">
                <!-- Current Weather Card -->
                <div class="weather-card">
                    <h3>Current Weather</h3>
                    <div class="current-weather">
                        <div class="weather-icon" id="weather-icon">üå§Ô∏è</div>
                        <div class="weather-details">
                            <div class="temperature" id="current-temp">--¬∞C</div>
                            <div class="humidity" id="current-humidity">Humidity: --%</div>
                            <div id="uv-index" style="margin-top: 5px; font-size: 0.9em; color: #636e72;"></div>
                        </div>
                    </div>
                    <div id="warnings"></div>
                </div>
                
                <!-- Temperature Readings -->
                <div class="weather-card">
                    <h3>Temperature Readings</h3>
                    <div class="locations-grid" id="temperature-locations"></div>
                </div>
                
                <!-- Rainfall Data -->
                <div class="weather-card">
                    <h3>Rainfall Data</h3>
                    <div id="rainfall-data"></div>
                </div>
                
                <!-- Lightning Warnings -->
                <div class="weather-card" id="lightning-card" style="display: none;">
                    <h3>‚ö° Lightning Warnings</h3>
                    <div id="lightning-data"></div>
                </div>
            </div>
            
            <!-- Temperature Chart -->
            <div class="weather-card">
                <h3>üìä Temperature History</h3>
                <div class="chart-controls">
                    <label for="time-range">Time Range:</label>
                    <select id="time-range">
                        <option value="24">Last 24 Hours</option>
                        <option value="48">Last 48 Hours</option>
                        <option value="72">Last 72 Hours</option>
                        <option value="168">Last 7 Days</option>
                        <option value="all" selected>All Time</option>
                    </select>
                    <label for="location-filter">Location:</label>
                    <select id="location-filter">
                        <option value="È¶ôÊ∏ØÂ§©ÊñáÂè∞">È¶ôÊ∏ØÂ§©ÊñáÂè∞</option>
                        <option value="all">All Locations</option>
                    </select>
                    <button onclick="updateTemperatureChart()">Update Chart</button>
                </div>
                <div class="chart-container">
                    <canvas id="temperature-chart"></canvas>
                </div>
            </div>
            
            <!-- Nine Day Forecast -->
            <div class="weather-card">
                <h3>üå§Ô∏è 9-Day Weather Forecast</h3>
                <div id="forecast-content">
                    <div class="loading">Loading forecast data...</div>
                </div>
            </div>
            
            <div class="last-updated">
                <div>Last Updated: <span id="last-updated-time">--</span></div>
                <button class="refresh-btn" onclick="loadWeatherData()">üîÑ Refresh Data</button>
            </div>
        </div>
    </div>

    <script>
        let currentWeatherData = null;
        let temperatureChart = null;
        let historicalData = [];
        
        // Weather icon mapping
        const weatherIcons = {
            50: '‚òÄÔ∏è',  // Sunny
            51: 'üå§Ô∏è',  // Sunny Periods
            52: 'üå§Ô∏è',  // Sunny Intervals
            53: 'üå§Ô∏è',  // Sunny Periods with A Few Showers
            54: 'üå§Ô∏è',  // Sunny Intervals with Showers
            60: '‚òÅÔ∏è',  // Cloudy
            61: '‚õÖ',  // Overcast
            62: 'üå©Ô∏è',  // Light Rain
            63: 'üåßÔ∏è',  // Rain
            64: '‚õàÔ∏è',  // Heavy Rain
            65: '‚õàÔ∏è',  // Thunderstorms
            70: 'üå®Ô∏è',  // Fine
            71: 'üå®Ô∏è',  // Light Snow
            72: '‚ùÑÔ∏è',  // Snow
            73: '‚ùÑÔ∏è',  // Heavy Snow
            74: 'üå®Ô∏è',  // Sleet
            75: 'üå®Ô∏è',  // Light Sleet
            76: 'üå®Ô∏è',  // Sleet and Snow
            77: 'üå®Ô∏è',  // Hail
            80: 'üå´Ô∏è',  // Windy
            81: 'üå™Ô∏è',  // Dry
            82: 'üå™Ô∏è',  // Humid
            83: 'üå´Ô∏è',  // Fog
            84: 'üå´Ô∏è',  // Mist
            85: 'üå´Ô∏è',  // Haze
            90: 'üå°Ô∏è',  // Hot
            91: 'üå°Ô∏è',  // Warm
            92: 'üßä',  // Cool
            93: 'üßä',  // Cold
            default: 'üå§Ô∏è'
        };
        
        async function loadWeatherData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('weather-content').style.display = 'none';
                
                // Get list of weather files
                const weatherFiles = await getWeatherFiles();
                
                if (weatherFiles.length === 0) {
                    throw new Error('No weather data files found');
                }
                
                // Load the most recent weather data
                const latestFile = weatherFiles[0];
                const response = await fetch(`weather_data/${latestFile}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const weatherData = await response.json();
                currentWeatherData = weatherData;
                
                // Load historical data for charts
                await loadHistoricalData();
                
                // Load forecast data
                await loadForecastData();
                
                displayWeatherData(weatherData);
                
                // Initialize temperature chart if Chart.js is available
                if (typeof Chart !== 'undefined') {
                    await initializeTemperatureChart();
                } else {
                    console.warn('Chart.js not loaded, skipping chart initialization');
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading weather data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading weather data: ${error.message}`;
            }
        }
        
        async function loadHistoricalData() {
            try {
                const files = await getWeatherFiles();
                historicalData = [];
                
                // Load last 100 files for historical data (or all available)
                const maxFiles = Math.min(files.length, 100);
                
                for (let i = 0; i < maxFiles; i++) {
                    try {
                        const response = await fetch(`weather_data/${files[i]}`);
                        if (response.ok) {
                            const data = await response.json();
                            const timestamp = extractTimestamp(files[i]);
                            
                            historicalData.push({
                                timestamp: timestamp,
                                filename: files[i],
                                data: data
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to load ${files[i]}:`, error);
                    }
                }
                
                // Sort by timestamp
                historicalData.sort((a, b) => a.timestamp - b.timestamp);
                
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }
        
        function extractTimestamp(filename) {
            const match = filename.match(/weather_(\d{8})_(\d{6})\.json/);
            if (match) {
                const [, dateStr, timeStr] = match;
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1; // months are 0-indexed
                const day = parseInt(dateStr.substring(6, 8));
                const hour = parseInt(timeStr.substring(0, 2));
                const minute = parseInt(timeStr.substring(2, 4));
                const second = parseInt(timeStr.substring(4, 6));
                
                return new Date(year, month, day, hour, minute, second);
            }
            return new Date();
        }
        
        async function loadForecastData() {
            try {
                // Try to load the most recent forecast file
                const forecastFiles = await getForecastFiles();
                
                if (forecastFiles.length > 0) {
                    const response = await fetch(`NineDayForecast/${forecastFiles[0]}`);
                    if (response.ok) {
                        const forecastData = await response.json();
                        displayForecastData(forecastData);
                        return;
                    }
                }
                
                // Fallback to sample data if no forecast files found
                const response = await fetch('NineDayForecast/forecast_sample.json');
                if (response.ok) {
                    const forecastData = await response.json();
                    displayForecastData(forecastData);
                } else {
                    document.getElementById('forecast-content').innerHTML = '<div class="error">No forecast data available</div>';
                }
                
            } catch (error) {
                console.error('Error loading forecast data:', error);
                document.getElementById('forecast-content').innerHTML = '<div class="error">Error loading forecast data</div>';
            }
        }
        
        async function getForecastFiles() {
            const files = [];
            const now = new Date();
            
            // Try to find forecast files from the last 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                
                // Try multiple times per day
                for (let hour = 0; hour < 24; hour++) {
                    const testDate = new Date(date);
                    testDate.setHours(hour, 0, 0, 0);
                    
                    const filename = `forecast_${testDate.getFullYear()}${String(testDate.getMonth() + 1).padStart(2, '0')}${String(testDate.getDate()).padStart(2, '0')}_${String(testDate.getHours()).padStart(2, '0')}${String(testDate.getMinutes()).padStart(2, '0')}${String(testDate.getSeconds()).padStart(2, '0')}.json`;
                    
                    try {
                        const response = await fetch(`NineDayForecast/${filename}`, { method: 'HEAD' });
                        if (response.ok) {
                            files.push(filename);
                        }
                    } catch (e) {
                        // File doesn't exist, continue
                    }
                }
            }
            
            return files.sort().reverse(); // Most recent first
        }
        
        function displayForecastData(data) {
            const container = document.getElementById('forecast-content');
            container.innerHTML = '';
            
            // Display general situation
            if (data.generalSituation) {
                const situationDiv = document.createElement('div');
                situationDiv.className = 'general-situation';
                situationDiv.innerHTML = `<strong>Â§©Ê∞£Ê¶ÇÊ≥Å:</strong> ${data.generalSituation}`;
                container.appendChild(situationDiv);
            }
            
            // Display forecast grid
            if (data.weatherForecast && data.weatherForecast.length > 0) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'forecast-grid';
                
                data.weatherForecast.forEach(forecast => {
                    const forecastDiv = document.createElement('div');
                    forecastDiv.className = 'forecast-item';
                    
                    const date = forecast.forecastDate;
                    const formattedDate = `${date.substring(4, 6)}/${date.substring(6, 8)}`;
                    
                    const icon = getForecastIcon(forecast.ForecastIcon);
                    
                    forecastDiv.innerHTML = `
                        <div class="forecast-date">${formattedDate}</div>
                        <div class="forecast-week">${forecast.week}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temp">${forecast.forecastMintemp.value}¬∞-${forecast.forecastMaxtemp.value}¬∞C</div>
                        <div class="forecast-weather">${forecast.forecastWeather}</div>
                        <div class="forecast-details">
                            ÈôçÈõ®Ê©üÁéá: ${forecast.PSR}<br>
                            ÊøïÂ∫¶: ${forecast.forecastMinrh.value}-${forecast.forecastMaxrh.value}%
                        </div>
                    `;
                    
                    gridDiv.appendChild(forecastDiv);
                });
                
                container.appendChild(gridDiv);
            }
        }
        
        function getForecastIcon(iconCode) {
            const forecastIcons = {
                50: '‚òÄÔ∏è',   // Sunny
                51: 'üå§Ô∏è',   // Sunny Periods
                52: 'üå§Ô∏è',   // Sunny Intervals
                53: 'üå¶Ô∏è',   // Sunny Periods with A Few Showers
                54: 'üå¶Ô∏è',   // Sunny Intervals with Showers
                60: '‚òÅÔ∏è',   // Cloudy
                61: '‚õÖ',   // Overcast
                62: 'üåßÔ∏è',   // Light Rain
                63: 'üåßÔ∏è',   // Rain
                64: 'üåßÔ∏è',   // Heavy Rain
                65: '‚õàÔ∏è',   // Thunderstorms
                70: 'üå®Ô∏è',   // Fine
                71: '‚ùÑÔ∏è',   // Light Snow
                72: '‚ùÑÔ∏è',   // Snow
                73: '‚ùÑÔ∏è',   // Heavy Snow
                80: 'üå´Ô∏è',   // Windy
                81: 'üå™Ô∏è',   // Dry
                82: 'üå™Ô∏è',   // Humid
                83: 'üå´Ô∏è',   // Fog
                84: 'üå´Ô∏è',   // Mist
                85: 'üå´Ô∏è',   // Haze
                default: 'üå§Ô∏è'
            };
            
            return forecastIcons[iconCode] || forecastIcons.default;
        }
        
        async function getWeatherFiles() {
            // List of known weather files from the directory
            const knownFiles = [
                'weather_20250717_083026.json',
                'weather_20250716_231010.json',
                'weather_20250716_221011.json',
                'weather_20250716_210946.json',
                'weather_20250716_201128.json',
                'weather_20250716_191003.json',
                'weather_20250716_181438.json',
                'weather_20250716_171220.json',
                'weather_20250716_161300.json',
                'weather_20250716_151053.json',
                'weather_20250716_141021.json',
                'weather_20250716_133022.json',
                'weather_20250716_122002.json',
                'weather_20250716_110918.json',
                'weather_20250716_101120.json',
                'weather_20250716_091527.json',
                'weather_20250716_081440.json',
                'weather_20250716_071321.json',
                'weather_20250716_061600.json',
                'weather_20250716_051658.json',
                'weather_20250715_230918.json',
                'weather_20250715_221021.json',
                'weather_20250715_210738.json',
                'weather_20250715_201140.json',
                'weather_20250715_191020.json',
                'weather_20250715_181459.json',
                'weather_20250715_170941.json',
                'weather_20250715_161306.json',
                'weather_20250715_150947.json',
                'weather_20250715_141142.json',
                'weather_20250715_132942.json',
                'weather_20250715_122015.json',
                'weather_20250715_110936.json',
                'weather_20250715_101116.json',
                'weather_20250715_091928.json',
                'weather_20250715_081449.json',
                'weather_20250715_071351.json',
                'weather_20250715_061555.json'
            ];
            
            const availableFiles = [];
            
            for (const filename of knownFiles) {
                try {
                    const response = await fetch(`weather_data/${filename}`, { method: 'HEAD' });
                    if (response.ok) {
                        availableFiles.push(filename);
                    }
                } catch (e) {
                    // File doesn't exist, continue
                }
            }
            
            return availableFiles.length > 0 ? availableFiles : knownFiles.slice(0, 10);
        }
        
        function displayWeatherData(data) {
            // Display current weather
            displayCurrentWeather(data);
            
            // Display temperature readings
            displayTemperatureReadings(data);
            
            // Display rainfall data
            displayRainfallData(data);
            
            // Display lightning warnings
            displayLightningWarnings(data);
            
            // Display last updated time
            displayLastUpdated(data);
        }
        
        function displayCurrentWeather(data) {
            // Set weather icon
            const iconElement = document.getElementById('weather-icon');
            const weatherIcon = data.icon && data.icon[0] ? weatherIcons[data.icon[0]] || weatherIcons.default : weatherIcons.default;
            iconElement.textContent = weatherIcon;
            
            // Set temperature (use Hong Kong Observatory as primary)
            const tempElement = document.getElementById('current-temp');
            const hkoTemp = data.temperature?.data?.find(t => t.place === 'È¶ôÊ∏ØÂ§©ÊñáÂè∞');
            if (hkoTemp) {
                tempElement.textContent = `${hkoTemp.value}¬∞${hkoTemp.unit}`;
            } else if (data.temperature?.data?.length > 0) {
                tempElement.textContent = `${data.temperature.data[0].value}¬∞${data.temperature.data[0].unit}`;
            }
            
            // Set humidity
            const humidityElement = document.getElementById('current-humidity');
            if (data.humidity?.data?.length > 0) {
                humidityElement.textContent = `Humidity: ${data.humidity.data[0].value}%`;
            }
            
            // Set UV index
            const uvElement = document.getElementById('uv-index');
            if (data.uvindex?.data?.length > 0) {
                const uvData = data.uvindex.data[0];
                uvElement.textContent = `UV Index: ${uvData.value} (${uvData.desc})`;
            }
            
            // Display warnings
            displayWarnings(data);
        }
        
        function displayWarnings(data) {
            const warningsContainer = document.getElementById('warnings');
            warningsContainer.innerHTML = '';
            
            if (data.warningMessage && data.warningMessage.length > 0) {
                data.warningMessage.forEach(warning => {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'warning alert';
                    warningDiv.textContent = warning;
                    warningsContainer.appendChild(warningDiv);
                });
            }
        }
        
        function displayTemperatureReadings(data) {
            const container = document.getElementById('temperature-locations');
            container.innerHTML = '';
            
            if (data.temperature?.data) {
                data.temperature.data.forEach(temp => {
                    const locationDiv = document.createElement('div');
                    locationDiv.className = 'location-item';
                    locationDiv.innerHTML = `
                        <div class="location-name">${temp.place}</div>
                        <div class="location-value">${temp.value}¬∞${temp.unit}</div>
                    `;
                    container.appendChild(locationDiv);
                });
            }
        }
        
        function displayRainfallData(data) {
            const container = document.getElementById('rainfall-data');
            container.innerHTML = '';
            
            if (data.rainfall?.data) {
                data.rainfall.data.forEach(rain => {
                    const rainfallDiv = document.createElement('div');
                    rainfallDiv.className = 'rainfall-item';
                    
                    let rainfallText = '';
                    if (rain.max !== undefined) {
                        if (rain.min !== undefined) {
                            rainfallText = `${rain.min}-${rain.max} ${rain.unit}`;
                        } else {
                            rainfallText = `${rain.max} ${rain.unit}`;
                        }
                    }
                    
                    rainfallDiv.innerHTML = `
                        <span>${rain.place}</span>
                        <span class="rainfall-value">${rainfallText}</span>
                    `;
                    container.appendChild(rainfallDiv);
                });
            }
        }
        
        function displayLightningWarnings(data) {
            const lightningCard = document.getElementById('lightning-card');
            const lightningContainer = document.getElementById('lightning-data');
            
            if (data.lightning?.data && data.lightning.data.length > 0) {
                lightningCard.style.display = 'block';
                lightningContainer.innerHTML = '';
                
                data.lightning.data.forEach(lightning => {
                    if (lightning.occur === 'true') {
                        const lightningDiv = document.createElement('div');
                        lightningDiv.className = 'warning alert';
                        lightningDiv.textContent = `Lightning detected in ${lightning.place}`;
                        lightningContainer.appendChild(lightningDiv);
                    }
                });
                
                if (data.lightning.startTime && data.lightning.endTime) {
                    const timeDiv = document.createElement('div');
                    timeDiv.style.marginTop = '10px';
                    timeDiv.style.fontSize = '0.9em';
                    timeDiv.textContent = `Valid from ${new Date(data.lightning.startTime).toLocaleString()} to ${new Date(data.lightning.endTime).toLocaleString()}`;
                    lightningContainer.appendChild(timeDiv);
                }
            } else {
                lightningCard.style.display = 'none';
            }
        }
        
        function displayLastUpdated(data) {
            const lastUpdatedElement = document.getElementById('last-updated-time');
            if (data.updateTime) {
                const updateTime = new Date(data.updateTime);
                lastUpdatedElement.textContent = updateTime.toLocaleString();
            }
        }
        
        async function initializeTemperatureChart() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }
            
            const ctx = document.getElementById('temperature-chart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (temperatureChart) {
                temperatureChart.destroy();
            }
            
            // Populate location filter
            populateLocationFilter();
            
            // Create chart
            temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Temperature Over Time'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 3
                        }
                    }
                }
            });
            
            // Update chart with data
            updateTemperatureChart();
        }
        
        function populateLocationFilter() {
            const locationFilter = document.getElementById('location-filter');
            const locations = new Set();
            
            // Collect all unique locations from historical data
            historicalData.forEach(item => {
                if (item.data.temperature && item.data.temperature.data) {
                    item.data.temperature.data.forEach(temp => {
                        locations.add(temp.place);
                    });
                }
            });
            
            // Clear existing options except first two
            while (locationFilter.options.length > 2) {
                locationFilter.remove(2);
            }
            
            // Add locations to filter
            Array.from(locations).sort().forEach(location => {
                if (location !== 'È¶ôÊ∏ØÂ§©ÊñáÂè∞') {
                    const option = document.createElement('option');
                    option.value = location;
                    option.textContent = location;
                    locationFilter.appendChild(option);
                }
            });
        }
        
        function updateTemperatureChart() {
            if (!temperatureChart || historicalData.length === 0) return;
            
            const timeRange = document.getElementById('time-range').value;
            const locationFilter = document.getElementById('location-filter').value;
            
            // Filter data by time range
            let filteredData = historicalData;
            if (timeRange !== 'all') {
                const hoursBack = parseInt(timeRange);
                const cutoffTime = new Date(Date.now() - hoursBack * 60 * 60 * 1000);
                filteredData = historicalData.filter(item => item.timestamp >= cutoffTime);
            }
            
            // Prepare chart data
            const labels = filteredData.map(item => item.timestamp.toLocaleDateString() + ' ' + item.timestamp.toLocaleTimeString());
            const datasets = [];
            
            if (locationFilter === 'all') {
                // Show multiple locations with different colors
                const colors = [
                    '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff',
                    '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0', '#ff6384'
                ];
                
                const locationData = {};
                
                // Group data by location
                filteredData.forEach(item => {
                    if (item.data.temperature && item.data.temperature.data) {
                        item.data.temperature.data.forEach(temp => {
                            if (!locationData[temp.place]) {
                                locationData[temp.place] = [];
                            }
                            locationData[temp.place].push(temp.value);
                        });
                    }
                });
                
                // Create datasets for top 5 locations
                let colorIndex = 0;
                Object.keys(locationData).slice(0, 5).forEach(location => {
                    datasets.push({
                        label: location,
                        data: locationData[location],
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        fill: false,
                        tension: 0.1
                    });
                    colorIndex++;
                });
            } else {
                // Show single location
                const temperatureData = [];
                
                filteredData.forEach(item => {
                    if (item.data.temperature && item.data.temperature.data) {
                        const temp = item.data.temperature.data.find(t => t.place === locationFilter);
                        if (temp) {
                            temperatureData.push(temp.value);
                        }
                    }
                });
                
                datasets.push({
                    label: locationFilter,
                    data: temperatureData,
                    borderColor: '#74b9ff',
                    backgroundColor: '#74b9ff20',
                    fill: false,
                    tension: 0.1
                });
            }
            
            // Update chart
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets = datasets;
            temperatureChart.update();
        }
        
        // Load weather data when page loads
        window.addEventListener('load', loadWeatherData);
        
        // Refresh data every 5 minutes
        setInterval(loadWeatherData, 5 * 60 * 1000);
    </script>
</body>
</html>